module.exports = { config: {
		      name: "ÙØ±ÙŠÙ‚",
		      aliases: ["ØªØ§Øº"],
		      version: "1.5",
		      author: "NTKhang", // ØªØ¹Ø±ÙŠØ¨: Ù…Ø­Ù…Ø¯ ØªØ§Ù†Ø¬ÙŠØ±Ùˆ \\
		      countDown: 5,
		      role: 0,
		      description: { ar: "Ø¹Ù…Ù„ ØªØ§Øº Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù† Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø£Ù†Øª ØªØ®ØªØ§Ø±Ù‡Ù…"},
		      category: "info",
		      guide: { ar: " {pn} [Ø§Ø¶Ø§ÙØ©] [Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚] [@Ø§Ù„ØªØ§ØºØ§Øª]: ØªØ³ØªØ®Ø¯Ù… Ù„Ø¥Ø¶Ø§ÙØ© ÙØ±ÙŠÙ‚ ØªØ§Øº Ø¬Ø¯ÙŠØ¯ØŒ Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ø£Ø¹Ø¶Ø§Ø¡ Ø¥Ù„Ù‰ ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ§Øº Ø§Ù„Ø°ÙŠ Ø£Ø¯Ø®Ù„ØªÙ‡\n"
				 + " Ù…Ø«Ø§Ù„:\n{pn} Ø§Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† @ØªØ§Øº1 @ØªØ§Øº2\n"
				 + " {pn} [Ø§Ø²Ø§Ù„Ø©] [Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚] [@Ø§Ù„ØªØ§ØºØ§Øª]: ØªØ³ØªØ®Ø¯Ù… Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ù…Ù† ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ§Øº\n"
				 + " Ù…Ø«Ø§Ù„:\n{pn} Ø§Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† @ØªØ§Øº1 @ØªØ§Øº2\n"
				 + " {pn} [Ø­Ø°Ù] [Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚]: ØªØ³ØªØ¹Ù…Ù„ Ù„Ø­Ø°Ù Ø§Ù„ÙØ±ÙŠÙ‚ \n"
				 + " Ù…Ø«Ø§Ù„:\n{pn} Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†\n"
				 + " {pn} [ØªØ§Øº] [Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚]: ØªØ³ØªØ¹Ù…Ù„ Ù„Ø¹Ù…Ù„ ØªØ§Øº Ù„ÙØ±ÙŠÙ‚ Ù…Ø¹ÙŠÙ†\n"
				 + " {pn} [ØªØ³Ù…ÙŠØ©] [Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚ | Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„ÙØ±ÙŠÙ‚]: ØªØ³ØªØ®Ø¯Ù… Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ø§Ù„ÙØ±ÙŠÙ‚\n"
				 + " {pn} [Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©]: ØªØ³ØªØ¹Ù…Ù„ Ù„Ø¹Ø±Ø¶ ÙØ±Ù‚ Ø§Ù„ØªØ§Øº Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©\n"
				 + " {pn} [Ù…Ø¹Ù„ÙˆÙ…Ø§Øª] [Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚]: ØªØ³ØªØ®Ø¯Ù… Ù„Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ§Øº"
		           } },

	langs: { ar: { noGroupTagName: "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ§Øº",
		       noMention: "Ù„Ù… ØªÙ‚Ù… Ø¨ØªØ§Øº Ù„Ø£ÙŠ Ø¹Ø¶Ùˆ Ù„Ø¥Ø¶Ø§ÙØªÙ‡ Ø¥Ù„Ù‰ Ø¹Ù„Ø§Ù…Ø© ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ§Øº",
		       addedSuccess: "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„ØªØ§Ù„ÙŠÙŠÙ† Ø¥Ù„Ù‰ ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ§Øº \"%1\":\n%2",
		       addedSuccess2: "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ§Øº \"%1\" Ù…Ø¹ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡:\n%2",
		       existedInGroupTag: "Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡:\n%1\nÙ…ÙˆØ¬ÙˆØ¯ÙŠÙ† Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ§Øº \"%2\"",
		       notExistedInGroupTag: "Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡:\n%1\nØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† ÙÙŠ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© \"%2\"",
		       noExistedGroupTag: "ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ§Øº \"%1\" ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©",
		       noExistedGroupTag2: "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£ÙŠ ÙØ±ÙŠÙ‚ ØªØ§Øº",
		       noMentionDel: "ÙŠØ±Ø¬Ù‰ ÙŠØ±Ø¬Ù‰ Ø¹Ù…Ù„ ØªØ§Øº Ù„Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ù„Ø¥Ø²Ø§Ù„ØªÙ‡Ù… Ù…Ù† ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ§Øº \"%1\"",
		       deletedSuccess: "ØªÙ… Ø­Ø°Ù Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡:\n%1\nÙ…Ù† ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ§Øº \"%2\"",
	               deletedSuccess2: "ØªÙ… Ø­Ø°Ù ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ§Øº \"%1\"",
		       tagged: "ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ§Øº \"%1\":\n%2",
		       noGroupTagName2: "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ§Øº Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ§Ø³Ù… ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ§Øº Ø§Ù„Ø¬Ø¯ÙŠØ¯ØŒ Ù…ÙØµÙˆÙ„ÙŠÙ† Ø¨Ù€: \"|\"",
		       renamedSuccess: "ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ø§Ù„ÙØ±ÙŠÙ‚ \"%1\" Ø¥Ù„Ù‰ \"%2\"",
		       infoGroupTag: "ðŸ“‘ | Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚: %1\nðŸ‘¥ | Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡: %2\nðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ | Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡:\n %3"
	       }     },

	onStart: async function ({ message, event, args, threadsData, getLang }) {
		const { threadID, mentions } = event;
		for (const uid in mentions)
			mentions[uid] = mentions[uid].replace("@", "");
		const groupTags = await threadsData.get(threadID, "data.groupTags", []);

		switch (args[0]) {
			case "Ø¥Ø¶Ø§ÙØ©":
			case "Ø§Ø¶Ø§ÙØ©": {
				const mentionsID = Object.keys(event.mentions);
				const content = (args.slice(1) || []).join(" ");
				const groupTagName = content.slice(0, content.indexOf(event.mentions[mentionsID[0]]) - 1).trim();
				if (!groupTagName)
					return message.reply(getLang("noGroupTagName"));
				if (mentionsID.length === 0)
					return message.reply(getLang("noMention"));

				const oldGroupTag = groupTags.find(tag => tag.name.toLowerCase() === groupTagName.toLowerCase());
				if (oldGroupTag) {
					const usersIDExist = [];
					const usersIDNotExist = [];
					for (const uid in mentions) {
						if (oldGroupTag.users.hasOwnProperty(uid)) {
							usersIDExist.push(uid);
						}
						else {
							oldGroupTag.users[uid] = mentions[uid];
							usersIDNotExist.push(uid);
						}
					}
					await threadsData.set(threadID, groupTags, "data.groupTags");

					let msg = "";
					if (usersIDNotExist.length > 0)
						msg += getLang("addedSuccess", oldGroupTag.name, usersIDNotExist.map(uid => mentions[uid]).join("\n")) + "\n";
					if (usersIDExist.length > 0)
						msg += getLang("existedInGroupTag", usersIDExist.map(uid => mentions[uid]).join("\n"));
					message.reply(msg);
				}
				else {
					const newGroupTag = {
						name: groupTagName,
						users: mentions
					};
					groupTags.push(newGroupTag);
					await threadsData.set(threadID, groupTags, "data.groupTags");
					message.reply(getLang("addedSuccess2", groupTagName, Object.values(mentions).join("\n")));
				}
				break;
			}
			case "Ù‚Ø§Ø¦Ù…Ø©":
			case "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©": {
				if (args[1]) {
					const groupTagName = args.slice(1).join(" ");
					if (!groupTagName)
						return message.reply(getLang("noGroupTagName"));
					const groupTag = groupTags.find(tag => tag.name.toLowerCase() === groupTagName.toLowerCase());
					if (!groupTag)
						return message.reply(getLang("noExistedGroupTag", groupTagName));
					return showInfoGroupTag(message, groupTag, getLang);
				}
				const msg = groupTags.reduce((msg, group) => msg + `\n\n${group.name}:\n ${Object.values(group.users).map(name => name).join("\n ")}`, "");
				message.reply(msg || getLang("noExistedGroupTag2"));
				break;
			}
			case "Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª":
			case "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª": {
				const groupTagName = args.slice(1).join(" ");
				if (!groupTagName)
					return message.reply(getLang("noGroupTagName"));
				const groupTag = groupTags.find(tag => tag.name.toLowerCase() === groupTagName.toLowerCase());
				if (!groupTag)
					return message.reply(getLang("noExistedGroupTag", groupTagName));
				return showInfoGroupTag(message, groupTag, getLang);
			}
			case "Ø¥Ø²Ø§Ù„Ø©":
			case "Ø§Ø²Ø§Ù„Ø©": {
				const content = (args.slice(1) || []).join(" ");
				const mentionsID = Object.keys(event.mentions);
				const groupTagName = content.slice(0, content.indexOf(mentions[mentionsID[0]]) - 1).trim();
				if (!groupTagName)
					return message.reply(getLang("noGroupTagName"));
				if (mentionsID.length === 0)
					return message.reply(getLang("noMention", groupTagName));
				const oldGroupTag = groupTags.find(tag => tag.name.toLowerCase() === groupTagName.toLowerCase());
				if (!oldGroupTag)
					return message.reply(getLang("noExistedGroupTag", groupTagName));
				const usersIDExist = [];
				const usersIDNotExist = [];
				for (const uid in mentions) {
					if (oldGroupTag.users.hasOwnProperty(uid)) {
						delete oldGroupTag.users[uid];
						usersIDExist.push(uid);
					}
					else {
						usersIDNotExist.push(uid);
					}
				}
				await threadsData.set(threadID, groupTags, "data.groupTags");

				let msg = "";
				if (usersIDNotExist.length > 0)
					msg += getLang("notExistedInGroupTag", usersIDNotExist.map(uid => mentions[uid]).join("\n"), groupTagName) + "\n";
				if (usersIDExist.length > 0)
					msg += getLang("deletedSuccess", usersIDExist.map(uid => mentions[uid]).join("\n"));
				message.reply(msg);
				break;
			}
			case "Ø­Ø°Ù": {
				const content = (args.slice(1) || []).join(" ");
				const groupTagName = content.trim();
				if (!groupTagName)
					return message.reply(getLang("noGroupTagName"));
				const index = groupTags.findIndex(group => group.name.toLowerCase() === groupTagName.toLowerCase());
				if (index === -1)
					return message.reply(getLang("noExistedGroupTag", groupTagName));
				groupTags.splice(index, 1);
				await threadsData.set(threadID, groupTags, "data.groupTags");
				message.reply(getLang("deletedSuccess2", groupTagName));
				break;
			}
			case "ØªØ³Ù…ÙŠØ©": {
				const content = (args.slice(1) || []).join(" ");
				const [oldGroupTagName, newGroupTagName] = content.split("|").map(str => str.trim());
				if (!oldGroupTagName || !newGroupTagName)
					return message.reply(getLang("noGroupTagName2"));
				const oldGroupTag = groupTags.find(tag => tag.name.toLowerCase() === oldGroupTagName.toLowerCase());
				if (!oldGroupTag)
					return message.reply(getLang("noExistedGroupTag", oldGroupTagName));
				oldGroupTag.name = newGroupTagName;
				await threadsData.set(threadID, groupTags, "data.groupTags");
				message.reply(getLang("renamedSuccess", oldGroupTagName, newGroupTagName));
				break;
			}
			case "ØªØ§Øº":
			default: {
				const content = (args.slice(args[0] === "tag" ? 1 : 0) || []).join(" ");
				const groupTagName = content.trim();
				if (!groupTagName)
					return message.reply(getLang("noGroupTagName"));
				const oldGroupTag = groupTags.find(tag => tag.name.toLowerCase() === groupTagName.toLowerCase());
				if (!oldGroupTag)
					return message.reply(getLang("noExistedGroupTag", groupTagName));
				const { users } = oldGroupTag;
				const mentions = [];
				let msg = "";
				for (const uid in users) {
					const userName = users[uid];
					mentions.push({
						id: uid,
						tag: userName
					});
					msg += `${userName}\n`;
				}
				message.reply({
					body: getLang("tagged", groupTagName, msg),
					mentions
				});
				break;
			}
		}
	}
};

function showInfoGroupTag(message, groupTag, getLang) {
	message.reply(getLang("infoGroupTag", groupTag.name, Object.keys(groupTag.users).length, Object.keys(groupTag.users).map(uid => groupTag.users[uid]).join("\n ")));
}
